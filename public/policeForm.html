<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Police Log</title>
    <link rel="stylesheet" href="CSS_file/policelog.css">
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

    <!-- Leaflet Control Geocoder for the search bar -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
</head>
<body>
    <div id="header">
        <div class="header-center">
            GeoCrime Tracker
        </div>
        <div class="header-right">
            <!-- <i class="bi bi-bell-fill"></i> Notification Bell Icon -->
            <i class="bi bi-person-circle" id="profile-icon"></i> <!-- Profile Icon -->
        </div>
    </div>
    <div class="profile-popup" id="profile-popup">
        <div class="profile-info">
            <p id="user-name"><strong>Name:</strong> Loading...</p>
            <p id="user-id"><strong>ID:</strong> Loading...</p>
        </div>
        <button id="logout-btn">Logout</button>
    </div>
    

        <!-- Content Wrapper  -->
        <div class="content">
            <!-- Sidebar -->
            <div id="sidebar">
                <ul>
                    <li id="CrimeMonitoringbox"><a href="CrimeMonitoring.html">Dashboard</a></li><hr>
                    <li id="predictiveanalysisbox"><a href="predictiveanalysis.html">Predictive Crime Analysis</a></li><hr>
                    <li id="hotspotanalysisbox"><a href="hotspotanalysis.html">Crime Hotspot Analysis</a></li><hr>
                    <li id="criminalpatternbox"><a href="criminalpattern.html">Criminal Behavior Patterns</a></li><hr>
                    <li id="policeFormbox"><a href="policeForm.html">Register New Crime</a></li>
                </ul>
            </div>
            <!-- policelog -->
            <div id="policelog">
                <div id="policelog-header">Crime Registration</div>
                <div class="container" id="polog-container">
                    <!-- Police Log Form -->
                    <!-- <form action="http://localhost:3000/submit" method="POST"> -->
                    <form id="crimeForm" action="/submit" method="POST" enctype="multipart/form-data">

                        <!-- Police Information Section -->
                        <fieldset>
                            <legend>Police Information</legend>
                            <div class="form-group">
                                <label for="polog-pid">Police ID</label>
                                <input type="number" id="polog-pid" name="polog_pid" placeholder="Not Available" readonly >
                            </div>
                            <div class="form-group">
                                <label for="polog-pname">Police Name</label>
                                <input type="text" id="polog-pname" name="polog_pname" placeholder="Not Available" readonly>
                            </div>
                        </fieldset>

                        <!-- Crime Information Section -->
                        <details class="toggle-section">
                            <summary>Crime Information</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="polog-crimetype">Crime Type</label>
                                    <select id="polog-crimetype" name="polog_crimetype" required>
                                        <option value="">Select Type of Crime</option>
                                        <option value="theft">Theft</option>
                                        <option value="assault">Assault</option>
                                        <option value="burglary">Burglary</option>
                                        <option value="fraud">Fraud</option>
                                        <option value="murder">Murder</option>
                                        <option value="vandalism">Vandalism</option>
                                        <option value="drugOffense">Drug Offense</option>
                                        <option value="domesticViolence">Domestic Violence</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="polog-crimedesc">Crime Description</label>
                                    <textarea id="polog-crimedesc" name="polog_crimedesc" placeholder="Describe the crime" ></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="polog-loc">Location</label>
                                    <input type="text" id="polog-loc" name="polog_loc" placeholder="Location of Crime" required>
                                </div>

                                <!-- Latitude and Longitude Fields (you can hide these if needed) -->
                                <div class="form-group">
                                    <!-- <label for="polog_lat">Latitude:</label> -->
                                    <input type="text" id="polog_lat" name="polog_lat" hidden required> <!-- Read-only to prevent manual entry -->
                                </div>
                                <div class="form-group">
                                    <!-- <label for="polog_lng">Longitude:</label> -->
                                    <input type="text" id="polog_lng" name="polog_lng" hidden required>
                                </div>
                                <!-- <div class="form-group">
                                    <label for="polog-pincode">Pincode</label>
                                    <input type="number" id="polog-pincode" name="polog_pincode" placeholder="Enter the Pincode" required>
                                </div> -->
                                <div class="form-group">
                                    <label for="polog-date">Date</label>
                                    <input type="date" id="polog-date" name="polog_date" required>
                                </div>
                                <div class="form-group">
                                    <label for="polog-time">Time</label>
                                    <input type="time" id="polog-time" name="polog_time" required>
                                </div>
                            </fieldset>
                        </details>

                        <!-- Victim Information Section -->
                        <details class="toggle-section">
                            <summary>Victim Information</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="polog-vname">Victim Name</label>
                                    <input type="text" id="polog-vname" name="polog_vname" placeholder="Enter Victim Name" required>
                                </div>
                                <div class="form-group">
                                    <label for="polog-vphone">Victim Phone Number</label>
                                    <input type="number" id="polog-vphone" name="polog_vphone" placeholder="Enter Victim Phone Number" required>
                                </div>
                                <div class="form-group">
                                    <label for="polog-vaddress">Victim Address</label>
                                    <textarea id="polog-vaddress" name="polog_vaddress" placeholder="Enter Victim Address" required></textarea>
                                </div>
                            </fieldset>
                        </details>

                        <!-- Criminal Information Section -->
                        <details class="toggle-section">
                            <summary>Criminal Information</summary>
                            <fieldset>
                                <div class="form-group">
                                    <label for="polog-cadhaarnum">Criminal Aadhaar Number</label>
                                    <input type="number" id="polog-cadhaarnum" name="polog_cadhaarnum" placeholder="Enter Criminal Aadhaar Number" >
                                    <button type="button" id="check-criminal-btn" class="btn">Check Criminal</button>
                                </div>
                                <div class="a4-preview" id="a4-preview">
                                    <!-- Placeholder for image preview -->
                                    <p>No photo uploaded yet.</p>
                                </div>
                                <div class="form-group">
                                    <label for="polog-photo">Upload Photo:</label>
                                    <input type="file" data-existing-photo="current_photo.jpg" name="criminal_photo" id="polog-photo" accept="image/*">
                                </div>
                                <div class="form-group">
                                    <label for="polog-cid">Criminal ID</label>
                                    <input type="number" id="polog-cid" name="polog_cid" placeholder="Enter Criminal ID" >
                                </div>
                                <div class="form-group">
                                    <label for="polog-cname">Criminal Name</label>
                                    <input type="text" id="polog-cname" name="polog_cname" placeholder="Enter Criminal Name" >
                                </div>
                            </fieldset>
                        </details>


                        <!-- Submit Button -->
                        <button type="submit" id="btn" class="btn">Register</button>
                    </form>
                </div>

            </div>

            <!-- Main Content -->
            <div class="main-content">
                <h5 class="text">Crime Registration</h5>
                <!-- Leaflet Map -->
                <div id="map"></div>
                
            </div>
        </div>
    

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Leaflet Control Geocoder for the search bar -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<script>
    const fileInput = document.getElementById('polog-photo');
    const previewContainer = document.getElementById('a4-preview');

    fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            // Create a file reader
            const reader = new FileReader();
            reader.onload = (e) => {
                // Clear the placeholder text
                previewContainer.innerHTML = '';

                // Create an image element
                const img = document.createElement('img');
                img.src = e.target.result;

                // Add the image to the preview container
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file); // Read file as a data URL
        }
        else {
            // Reset preview if no file is selected
            previewContainer.innerHTML = '<p>No photo uploaded yet.</p>';
        }
    });
</script>

<script>
    // JavaScript to ensure only one details section is open at a time
    const toggleSections = document.querySelectorAll('.toggle-section');

    toggleSections.forEach(section => {
        section.addEventListener('toggle', () => {
            if (section.open) {
                toggleSections.forEach(otherSection => {
                    if (otherSection !== section) {
                        otherSection.open = false;
                    }
                });
            }
        });
    });

    document.getElementById('check-criminal-btn').addEventListener('click', () => {
    const aadhaarNumber = document.getElementById('polog-cadhaarnum').value;
    console.log('Aadhaar Number to be sent:', aadhaarNumber);

    if (!aadhaarNumber) {
        alert('Please enter an Aadhaar number');
        return;
    }

    if (aadhaarNumber.length!=12) {
        alert('Please enter valid Aadhaar number');
        return;
    }

    fetch('/check-criminal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ aadhaar: aadhaarNumber.toString().trim() })
    })
    .then(response => {
    if (!response.ok) {
    throw new Error('Network response was not ok');
    }
    return response.json();  // Ensures only valid JSON is parsed
    })
    .then(data => {
        if (data.found) {
            alert('Criminal found.');
            const previewContainer = document.getElementById('a4-preview');
            previewContainer.innerHTML = ''; // Clear previous content

            if (data.photo) {
            const img = document.createElement('img');
            img.src = data.photo; // Use the full URL
            img.alt = 'Criminal Photo';
            img.style.width = '200px'; // Adjust size as needed
            img.style.height = 'auto';
            previewContainer.appendChild(img);
            
            // Set the filename value for the file input
            const fileInputs = document.getElementById('polog-photo');
            const photoPath = data.photo.split('/').pop(); // Get just the filename
            fileInputs.setAttribute('data-existing-photo', photoPath); // Store filename in data attribute
            }
            else {
                previewContainer.textContent = 'No photo available.';
            }
            
            document.getElementById('polog-cid').value = data.id;
            document.getElementById('polog-cname').value = data.name;
        }
        else {
            alert('Criminal not found. You can add a new criminal.');
            document.getElementById('polog-cid').value = '';
            document.getElementById('polog-cname').value = '';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while checking the criminal.');
    });
});
</script>





<script>
    document.getElementById('crimeForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Prevent the default form submission
        console.log('Submit button clicked');

        const fileInput = document.getElementById('polog-photo');
        const existingPhoto = fileInput.getAttribute('data-existing-photo') || ''; // Get the existing photo filename

        const formData = new FormData();
        formData.append('polog_pid', document.getElementById('polog-pid').value);
        formData.append('polog_pname', document.getElementById('polog-pname').value);
        formData.append('polog_crimetype', document.getElementById('polog-crimetype').value);
        formData.append('polog_crimedesc', document.getElementById('polog-crimedesc').value);
        formData.append('polog_loc', document.getElementById('polog-loc').value);
        formData.append('polog_lat', document.getElementById('polog_lat').value);
        formData.append('polog_lng', document.getElementById('polog_lng').value);
        formData.append('polog_date', document.getElementById('polog-date').value);
        formData.append('polog_time', document.getElementById('polog-time').value);
        formData.append('polog_vname', document.getElementById('polog-vname').value);
        formData.append('polog_vphone', document.getElementById('polog-vphone').value);
        formData.append('polog_vaddress', document.getElementById('polog-vaddress').value);
        formData.append('polog_cadhaarnum', document.getElementById('polog-cadhaarnum').value);
        // formData.append('criminal_photo', document.getElementById('polog-photo').files[0]);
        if (fileInput.files.length > 0) {
            formData.append('criminal_photo', fileInput.files[0]); // New photo
        }
        else {
            formData.append('criminal_photo', existingPhoto);
        }

        formData.append('polog_cid', document.getElementById('polog-cid').value);
        formData.append('polog_cname', document.getElementById('polog-cname').value);
    
        // Send data to the server using fetch API
        fetch('/submit', {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                alert(data.message); // Show success message
                window.location.href = '/policeForm.html'; // Optionally clear the form
            }
        })
        .catch(error => console.error('Error:', error));
    });


    window.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split("T")[0]; // Get current date in YYYY-MM-DD format
        document.getElementById('polog-date').max = today;
    });
</script>





<script>
    // Make the policelog element draggable by its header
    function makeDraggable(draggableElement) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
        // Get the header element for dragging
        const header = document.getElementById(draggableElement.id + "-header");
    
        // Only make the header draggable
        if (header) {
            header.onmousedown = dragMouseDown;
        }
    
        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Call a function whenever the cursor moves
            document.onmousemove = elementDrag;
        }
    
        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // Set the element's new position
            draggableElement.style.top = (draggableElement.offsetTop - pos2) + "px";
            draggableElement.style.left = (draggableElement.offsetLeft - pos1) + "px";
        }
    
        function closeDragElement() {
            // Stop moving when mouse button is released
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
    
    // Apply the draggable function to the #policelog element
    makeDraggable(document.getElementById("policelog"));
</script>




<script>
    // Initialize the map and set its view
    var map = L.map('map').setView([19.0760, 72.8777], 11);  // Centered on Mumbai

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">Brighton</a> contributors'
    }).addTo(map);
    //L.marker([19.0760, 72.8777]).addTo(map).bindPopup('Mumbai').openPopup();

    

    // Function to style the GeoJSON layers
    function style1(feature) {
        return {
            color: "#ff7800",
            
            weight: 1,
            opacity: 0.65
        };
    }

    function style2(feature) {
        return {
            color: "#0057e7",
            weight: 1,
            opacity: 0.75
        };
    }



        // Function to bind popup information for each feature
    function onEachFeature1(feature, layer) {
        if (feature.properties && feature.properties.Name) {
            layer.bindPopup("<strong> Station :</strong> " + feature.properties.Name);
        } else {
            console.warn('Feature properties not found for layer 1:', feature);
        }
    }

    function onEachFeature2(feature, layer) {
        if (feature.properties && feature.properties.Name) {
            layer.bindPopup("<strong> Juridiction :</strong> " + feature.properties.Name);
        } else {
            console.warn('Feature properties not found for layer 2:', feature);
        }
    }




    // Create a custom icon with a specific color
    var customIcon = L.icon({
        iconUrl: 'pics/redcrime.png',  // Path to custom marker icon image
        iconSize: [20, 20],    // Icon size
        iconAnchor: [10, 20] // Point where the icon is anchored (center-bottom)
    });

    // Use the custom icon in pointToLayer
    function pointToCustomMarker(feature, latlng) {
        return L.marker(latlng, { icon: customIcon })
            .bindPopup(feature.properties.description); // Bind popup with description
    }



    // Function to create circle markers for GeoJSON points
    function pointToCircle(feature, latlng) {
        return L.circle(latlng, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 3000 // Adjust the radius as needed
        }).bindPopup(feature.properties.description); // Bind popup with description
    }


    // Function to create both a custom marker and a circle for the same point
    function pointToCustomMarkerAndCircle(feature, latlng) {
        // Create the custom marker
        var customIcon = L.icon({
            iconUrl: 'pics/redcrime.png',  // Path to your custom icon
            iconSize: [20, 20],    // Icon size
            iconAnchor: [10, 20]    // Adjust the anchor as needed
        });
        var marker = L.marker(latlng, { icon: customIcon }).bindPopup(feature.properties.name);

        // Create the circle around the same point
        var circle = L.circle(latlng, {
            color: '',
            fillColor: 'rgb(226, 128, 42)',
            fillOpacity: 0.5,
            radius: 1000 // Adjust radius as needed
        });

        // Add both the marker and the circle to a LayerGroup
        return L.layerGroup([marker, circle]);
    }




    // Define GeoJSON layers
    var geojsonLayer1 = L.geoJSON(null, {
        style: style1,
        onEachFeature: onEachFeature1,
        //pointToLayer: pointToCustomMarker
    });

    var geojsonLayer2 = L.geoJSON(null, {
        style: style2,
        onEachFeature: onEachFeature2
    });



    
    // Load GeoJSON files and add data to layers
    fetch('geojson/Point_Police_Station.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer1.addData(data);
            })
            .catch(error => console.error('Error loading GeoJSON 1:', error));

    fetch('geojson/Police_Station_Jurdition.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer2.addData(data);
            })
            .catch(error => console.error('Error loading GeoJSON 2:', error));

    
    
    // Add geocoder control (search bar)
    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false  // Do not mark location automatically
    }).on('markgeocode', function(e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
            [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
            [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
            [bbox.getSouthWest().lat, bbox.getSouthWest().lng]
        ]).addTo(map);
        
        // Zoom the map to the selected location
        map.fitBounds(poly.getBounds());

        // Optionally, show a marker at the location
        var latlng = e.geocode.center;
        L.marker(latlng).addTo(map)
            .bindPopup("<strong>Location Found:</strong><br>" + e.geocode.name)
            .openPopup();
        }).addTo(map);  // Add the geocoder control to the map

    // When the map is clicked, get latitude and longitude
    var marker; // Define marker outside the map click event

    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker); // Remove previous marker
        }

        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        marker = L.marker(e.latlng).addTo(map)
            .bindPopup("<strong>Coordinates:</strong><br>Lat: " + lat + "<br>Lng: " + lng)
            .openPopup();
        
        document.getElementById('polog_lat').value = lat;
        document.getElementById('polog_lng').value = lng;

        // Reverse Geocode: Convert Lat/Lng to address using OpenStreetMap Nominatim API
        const apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                if (data && data.display_name) {
                    // Set the address field in the form
                    document.getElementById('polog-loc').value = data.display_name;
                    
                } else {
                    document.getElementById('polog-loc').value = 'Address not found';
                }
            })
            .catch(error => {
                document.getElementById('polog-loc').value = 'Error fetching address';
                alert('Error fetching address: ' + error.message);
            });
    });



    

    // Add base layers to the layer control
    var baseMaps = {
        "Police Stations": geojsonLayer1,
        "Station Jurisdiction": geojsonLayer2,
        //"Crime": geojsonLayer3 // Initially, this layer will be empty until data is loaded
    };
    
    // Layer control to toggle layers
    L.control.layers(null, baseMaps).addTo(map);

</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const profileIcon = document.getElementById("profile-icon");
        const profilePopup = document.getElementById("profile-popup");
        const userName = document.getElementById("user-name");
        const userId = document.getElementById("user-id");

        // Fetch user info from the server
        function fetchUserInfo() {
            fetch('/get-user')
                .then(response => response.json())
                .then(data => {
                    if (data.user) {
                        userName.innerHTML = `<strong>Name:</strong> ${data.user.name}`;
                        userId.innerHTML = `<strong>ID:</strong> ${data.user.id}`;
                    } else {
                        userName.innerHTML = `<strong>Name:</strong> Guest`;
                        userId.innerHTML = `<strong>ID:</strong> Not available`;
                    }
                })
                .catch(error => console.error('Error fetching user info:', error));
        }

        // Show the profile pop-up
        profileIcon.addEventListener("click", () => {
            fetchUserInfo();
            profilePopup.style.display = profilePopup.style.display === "block" ? "none" : "block";
        });

        // Close the popup when clicking outside
        document.addEventListener("click", (event) => {
            if (!profileIcon.contains(event.target) && !profilePopup.contains(event.target)) {
                profilePopup.style.display = "none";
            }
        });

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", () => {
            const isConfirmed = confirm("Are you sure want to logout?");
            if (isConfirmed) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        alert('You have been logged out.');
                        window.location.href = '/login.html';
                    })
                    .catch(error => console.error('Error logging out:', error));
            }
        });
    });

</script>
<script>
    fetch('/get-user')
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                document.getElementById('polog-pid').value = data.user.id;
                document.getElementById('polog-pname').value = data.user.name;
            } else {
                document.getElementById('polog-pid').value = '';
                document.getElementById('polog-pname').value = '';
            }
        })
        .catch(error => console.error('Error fetching user info:', error));
</script>
</body>
</html>