<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criminal Behavior Patterns</title>
  <link rel="stylesheet" href="CSS_file/criminalpatt.css">
  <!-- Bootstrap CSS -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Leaflet Control Geocoder for the search bar -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  

</head>
<body>
    <div id="header">
        <div class="header-center">
            GeoCrime Tracker
        </div>
        <div class="header-right">
            <!-- <i class="bi bi-bell-fill"></i> Notification Bell Icon -->
            <i class="bi bi-person-circle" id="profile-icon"></i> <!-- Profile Icon -->
        </div>
    </div>
    <div class="profile-popup" id="profile-popup">
        <div class="profile-info">
            <p id="user-name"><strong>Name:</strong> Loading...</p>
            <p id="user-id"><strong>ID:</strong> Loading...</p>
        </div>
        <button id="logout-btn">Logout</button>
    </div>
    

        <!-- Content Wrapper  -->
        <div class="content">
            <!-- Sidebar -->
            <div id="sidebar">
                <ul>
                    <li id="CrimeMonitoringbox"><a href="CrimeMonitoring.html">Dashboard</a></li><hr>
                    <li id="predictiveanalysisbox"><a href="predictiveanalysis.html">Predictive Crime Analysis</a></li><hr>
                    <li id="hotspotanalysisbox"><a href="hotspotanalysis.html">Crime Hotspot Analysis</a></li><hr>
                    <li id="criminalpatternbox"><a href="criminalpattern.html">Criminal Behavior Patterns</a></li><hr>
                    <li id="policeFormbox"><a href="policeForm.html">Register New Crime</a></li>
                </ul>
            </div>
    
            <!-- Main Content -->
            <div class="main-content">
                <div id="search-container">
                    <h5 class="text">Criminal Behavior Patterns</h5>
                    <div id="search">
                    
                        <input type="text" id="cri-name" placeholder=" Criminal Name">
                    
                        <button id="btn-sc" onclick="search()">Search</button>
                    </div>
                </div>
                
                <!-- Leaflet Map -->
                <div id="map"></div>
                
            </div>
            
        </div>
    

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Leaflet Heatmap Plugin -->
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<!-- Leaflet Control Geocoder for the search bar -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>


<script>
    // Initialize the map and set its view
    var map = L.map('map').setView([19.0760, 72.8777], 11);  // Centered on Mumbai

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">Brighton</a> contributors'
    }).addTo(map);
    //L.marker([19.0760, 72.8777]).addTo(map).bindPopup('Mumbai').openPopup();

    

    // Function to style the GeoJSON layers
    function style1(feature) {
        return {
            color: "#ff7800",
            
            weight: 1,
            opacity: 0.65
        };
    }

    function style2(feature) {
        return {
            color: "#0057e7",
            weight: 1,
            opacity: 0.75
        };
    }


        // Function to bind popup information for each feature
    function onEachFeature1(feature, layer) {
        if (feature.properties && feature.properties.Name) {
            layer.bindPopup("<strong> Station :</strong> " + feature.properties.Name);
        } else {
            console.warn('Feature properties not found for layer 1:', feature);
        }
    }

    function onEachFeature2(feature, layer) {
        if (feature.properties && feature.properties.Name) {
            layer.bindPopup("<strong> Juridiction :</strong> " + feature.properties.Name);
        } else {
            console.warn('Feature properties not found for layer 2:', feature);
        }
    }



    // Create a custom icon with a specific color
    var customIcon = L.icon({
        iconUrl: 'pics/standing-up-man-.png',  // Path to custom marker icon image
        iconSize: [16, 16],    // Icon size
        iconAnchor: [8, 16] // Point where the icon is anchored (center-bottom)
    });

    // Use the custom icon in pointToLayer
    function pointToCustomMarker(feature, latlng) {
        return L.marker(latlng, { icon: customIcon })
            .bindPopup(feature.properties.description); // Bind popup with description
    }




    // Define GeoJSON layers
    var geojsonLayer1 = L.geoJSON(null, {
        style: style1,
        onEachFeature: onEachFeature1,
        //pointToLayer: pointToCustomMarker
    });  // Add layer to map immediately

    var geojsonLayer2 = L.geoJSON(null, {
        style: style2,
        onEachFeature: onEachFeature2
    });  // Add layer to map immediately

    


    
    // Load GeoJSON files and add data to layers
    fetch('geojson/Point_Police_Station.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer1.addData(data);
            })
            .catch(error => console.error('Error loading GeoJSON 1:', error));

    fetch('geojson/Police_Station_Jurdition.geojson')
            .then(response => response.json())
            .then(data => {
                geojsonLayer2.addData(data);
            })
            .catch(error => console.error('Error loading GeoJSON 2:', error));



// Function to generate distinct colors for each criminal


const colors = [
    "rgb(236, 11, 11)","rgb(3, 23, 240)","rgb(28, 145, 5)","rgb(197, 200, 5)",
    "rgb(105, 4, 102)","rgb(3, 211, 197)","rgb(206, 131, 20)","rgb(195, 43, 122)",
    // "rgb(79, 244, 156)","rgb(181, 123, 14)","rgb(168, 9, 91)",

];

function getDistinctColor(index) {
    return colors[index % colors.length];
}



function search() {
    const criminalName = document.getElementById('cri-name').value;
    
    // Fetch data from the API
    fetch(`/api/criminals?name=${encodeURIComponent(criminalName)}`)
        .then(response => response.json())
        .then(data => {
            // Clear previous markers and polylines
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    map.removeLayer(layer);
                }
            });

            // Group locations by criminal
            const criminalLocations = {};
            const criminalColors = {};
            let criminalIndex = 0;

            // Organize crimes by criminal and filter out null criminal names
            data.filter(crime => crime.criminal_name).forEach((crime) => {
                if (!criminalLocations[crime.criminal_name]) {
                    criminalLocations[crime.criminal_name] = [];
                    criminalColors[crime.criminal_name] = getDistinctColor(criminalIndex++);
                }
                criminalLocations[crime.criminal_name].push({
                    lat: crime.latitude,
                    lng: crime.longitude,
                    crime_type: crime.crime_type,
                    description: crime.crime_dec,
                    date: crime.date,
                    criminal_photo: crime.criminal_photo
                });
            });

            // Plot data on the map
            Object.keys(criminalLocations).forEach((criminalName) => {
                const locations = criminalLocations[criminalName];
                const latlngs = locations.map(loc => [loc.lat, loc.lng]);

                // Add polyline for the criminal's movement
                const polyline = L.polyline(latlngs, {
                    color: criminalColors[criminalName],
                    weight: 3,
                    opacity: 0.8
                }).addTo(map);

                
            // Add markers for each crime location
            locations.forEach(loc => {
                const marker = L.marker([loc.lat, loc.lng], { icon: customIcon }).addTo(map);

                // Attach click event to show movable popup form
                marker.on('click', () => {
                    // Remove any existing popup form before creating a new one
                    const existingPopup = document.getElementById('popupForm');
                    if (existingPopup) {
                        document.body.removeChild(existingPopup);
                    }

                    // Create the popup form
                    const popupForm = document.createElement('div');
                    popupForm.id = 'popupForm';
                    popupForm.style.position = 'fixed';
                    popupForm.style.top = '140px';
                    popupForm.style.left = '250px';
                    popupForm.style.backgroundColor = '#acaaaa';
                    popupForm.style.border = '1px solid #ccc';
                    popupForm.style.borderRadius = '8px';
                    popupForm.style.padding = '10px';
                    popupForm.style.boxShadow = '2px 2px 10px rgba(0, 0, 0, 0.25)';
                    popupForm.style.zIndex = 1000;
                    popupForm.style.overflowY = 'auto';
                    popupForm.style.width = '380px';
                    popupForm.style.height = '400px';
                    popupForm.style.resize = 'both';
                    
                    popupForm.innerHTML = `
                        
                        <div id="popupForm-header">
                            <button id="closePopup">&times;</button>
                            <h4 style="margin: 0;">Criminal Record</h4>
                        </div>
                        <form id="popupForm">
                            <div class="a4-preview" id="a4-preview">
                                    <!-- Placeholder for image preview -->
                                    <p>No photo uploaded yet.</p>
                            </div>
                            <label><strong>Criminal</strong></label>
                            <input type="text" value="${criminalName}" readonly /><br><br>

                            <label><strong>Crime</strong></label>
                            <input type="text" value="${loc.crime_type}" readonly />

                            <label><strong>Description</strong></label>
                            <textarea readonly>${loc.description}</textarea>
                            <label><strong>Date</strong></label>
                            <input type="text" value="${loc.date}" readonly />

                        </form>
                    `;

                    // Add form to the body
                    document.body.appendChild(popupForm);

                    const previewContainer = document.getElementById('a4-preview');
                    previewContainer.innerHTML = ''; // Clear previous content
                    
                    const photoFilename = loc.criminal_photo;
                    const photoPath = photoFilename
                        ? `/uploads/photos/${photoFilename}` // Full URL
                        : `pics/profile.png`;
                    console.log('Criminal Photo:', loc.criminal_photo);
                    console.log('Photo Filename:', photoFilename);
                    console.log('Photo Path:', photoPath);
                    if (photoPath) {
                        const img = document.createElement('img');
                        img.src = photoPath; // Use the full URL
                        img.alt = 'Criminal Photo';
                        img.style.width = '200px'; // Adjust size as needed
                        img.style.height = 'auto';
                        previewContainer.appendChild(img);
                        
                    }
                    else {
                        previewContainer.textContent = 'No photo available.';
                    }
                    

                    // Handle closing the popup
                    document.getElementById('closePopup').addEventListener('click', () => {
                        document.body.removeChild(popupForm);
                    });
                    // Make the popup form draggable
                    makeDraggable(popupForm);
                });

                
                // Draggable function
                function makeDraggable(draggableElement) {
                    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

                    const header = document.getElementById(`${draggableElement.id}-header`);

                    if (header) {
                        header.onmousedown = dragMouseDown;
                    } else {
                        draggableElement.onmousedown = dragMouseDown;
                    }

                    function dragMouseDown(e) {
                        e = e || window.event;
                        e.preventDefault();
                        // Initial mouse position
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        document.onmouseup = closeDragElement;
                        document.onmousemove = elementDrag;
                    }

                    function elementDrag(e) {
                        e = e || window.event;
                        e.preventDefault();
                        // Calculate new cursor position
                        pos1 = pos3 - e.clientX;
                        pos2 = pos4 - e.clientY;
                        pos3 = e.clientX;
                        pos4 = e.clientY;
                        // Update the element's position
                        draggableElement.style.top = (draggableElement.offsetTop - pos2) + "px";
                        draggableElement.style.left = (draggableElement.offsetLeft - pos1) + "px";
                    }

                    function closeDragElement() {
                        document.onmouseup = null;
                        document.onmousemove = null;
                    }
                }
            });
                // Add popup to polyline
                polyline.bindPopup(`<strong>Criminal:</strong> ${criminalName}`);
            });
        })
        .catch(error => {
            console.error('Error fetching criminal data:', error);
        });
}

// Initial load: Fetch all data
search();





    // Add geocoder control (search bar)
    var geocoder = L.Control.geocoder({
        defaultMarkGeocode: false  // Do not mark location automatically
    }).on('markgeocode', function(e) {
        var bbox = e.geocode.bbox;
        var poly = L.polygon([
            [bbox.getSouthEast().lat, bbox.getSouthEast().lng],
            [bbox.getNorthEast().lat, bbox.getNorthEast().lng],
            [bbox.getNorthWest().lat, bbox.getNorthWest().lng],
            [bbox.getSouthWest().lat, bbox.getSouthWest().lng]
        ]).addTo(map);
        
        // Zoom the map to the selected location
        map.fitBounds(poly.getBounds());

        // Optionally, show a marker at the location
        var latlng = e.geocode.center;
        L.marker(latlng).addTo(map)
            .bindPopup("<strong>Location Found:</strong><br>" + e.geocode.name)
            .openPopup();
        }).addTo(map);  // Add the geocoder control to the map




    

    // Add base layers to the layer control
    var baseMaps = {
        "Police Stations": geojsonLayer1,
        "Station Jurisdiction": geojsonLayer2,
        // "Crime": geojsonLayer3 // Initially, this layer will be empty until data is loaded
    };
    
    // Layer control to toggle layers
    L.control.layers(null, baseMaps).addTo(map);


</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const profileIcon = document.getElementById("profile-icon");
        const profilePopup = document.getElementById("profile-popup");
        const userName = document.getElementById("user-name");
        const userId = document.getElementById("user-id");

        // Fetch user info from the server
        function fetchUserInfo() {
            fetch('/get-user')
                .then(response => response.json())
                .then(data => {
                    if (data.user) {
                        userName.innerHTML = `<strong>Name:</strong> ${data.user.name}`;
                        userId.innerHTML = `<strong>ID:</strong> ${data.user.id}`;
                    } else {
                        userName.innerHTML = `<strong>Name:</strong> Guest`;
                        userId.innerHTML = `<strong>ID:</strong> Not available`;
                    }
                })
                .catch(error => console.error('Error fetching user info:', error));
        }

        // Show the profile pop-up
        profileIcon.addEventListener("click", () => {
            fetchUserInfo();
            profilePopup.style.display = profilePopup.style.display === "block" ? "none" : "block";
        });

        // Close the popup when clicking outside
        document.addEventListener("click", (event) => {
            if (!profileIcon.contains(event.target) && !profilePopup.contains(event.target)) {
                profilePopup.style.display = "none";
            }
        });

        // Logout functionality
        document.getElementById("logout-btn").addEventListener("click", () => {
            const isConfirmed = confirm("Are you sure want to logout?");
            if (isConfirmed) {
                fetch('/logout', { method: 'POST' })
                    .then(() => {
                        alert('You have been logged out.');
                        window.location.href = '/login.html';
                    })
                    .catch(error => console.error('Error logging out:', error));
            }
        });
    });

</script>

</body>
</html>